# ðŸš€ Makefile pour TKF Backend Django

.PHONY: help install migrate run test clean docker-build docker-up docker-down

# Couleurs
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m # No Color

help:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ðŸš€ TKF Backend Django - Commandes Utiles â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Installation & Setup:$(NC)"
	@echo "  make install          - Installer les dÃ©pendances"
	@echo "  make migrate          - Appliquer les migrations"
	@echo "  make superuser        - CrÃ©er un superuser"
	@echo "  make init-roles       - Initialiser les rÃ´les"
	@echo "  make seed-users       - CrÃ©er les utilisateurs par dÃ©faut"
	@echo "  make setup            - Setup complet (install + migrate + roles + users)"
	@echo ""
	@echo "$(GREEN)DÃ©veloppement:$(NC)"
	@echo "  make run              - Lancer le serveur de dÃ©veloppement"
	@echo "  make shell            - Django shell"
	@echo "  make makemigrations   - CrÃ©er les migrations"
	@echo ""
	@echo "$(GREEN)Tests:$(NC)"
	@echo "  make test             - ExÃ©cuter tous les tests"
	@echo "  make test-users       - Tests du module users"
	@echo "  make coverage         - Coverage report"
	@echo ""
	@echo "$(GREEN)Code Quality:$(NC)"
	@echo "  make lint             - ExÃ©cuter les linters (black, flake8, isort)"
	@echo "  make format           - Formater le code"
	@echo "  make mypy             - Type checking"
	@echo ""
	@echo "$(GREEN)Database:$(NC)"
	@echo "  make reset-db         - RÃ©initialiser la DB (âš ï¸  donnÃ©es perdues)"
	@echo "  make dumpdata         - Backup DB en JSON"
	@echo "  make loaddata         - Restaurer depuis JSON"
	@echo ""
	@echo "$(GREEN)Docker:$(NC)"
	@echo "  make docker-build     - Builder les images"
	@echo "  make docker-up        - Lancer les containers"
	@echo "  make docker-down      - ArrÃªter les containers"
	@echo "  make docker-logs      - Voir les logs"
	@echo ""
	@echo "$(GREEN)Utilitaires:$(NC)"
	@echo "  make clean            - Nettoyer les fichiers temporaires"
	@echo "  make check            - VÃ©rifier la configuration Django"
	@echo ""

# Installation
install:
	@echo "$(BLUE)Installation des dÃ©pendances...$(NC)"
	pip install --upgrade pip setuptools wheel
	pip install -r requirements.txt
	pip install -r requirements-dev.txt
	@echo "$(GREEN)âœ“ Installation terminÃ©e$(NC)"

setup: install migrate init-roles seed-users
	@echo "$(GREEN)âœ“ Setup complet terminÃ©$(NC)"

# Database
migrate:
	@echo "$(BLUE)Application des migrations...$(NC)"
	python manage.py migrate
	@echo "$(GREEN)âœ“ Migrations appliquÃ©es$(NC)"

makemigrations:
	@echo "$(BLUE)CrÃ©ation des migrations...$(NC)"
	python manage.py makemigrations
	@echo "$(GREEN)âœ“ Migrations crÃ©Ã©es$(NC)"

superuser:
	@echo "$(BLUE)CrÃ©ation d'un superuser...$(NC)"
	python manage.py createsuperuser

init-roles:
	@echo "$(BLUE)Initialisation des rÃ´les et permissions...$(NC)"
	python manage.py init_roles
	@echo "$(GREEN)âœ“ RÃ´les crÃ©Ã©s$(NC)"

seed-users:
	@echo "$(BLUE)CrÃ©ation des utilisateurs par dÃ©faut...$(NC)"
	python manage.py seed_users
	@echo "$(GREEN)âœ“ Utilisateurs crÃ©Ã©s$(NC)"

reset-db:
	@echo "$(YELLOW)âš ï¸  RÃ©initialisation de la base de donnÃ©es...$(NC)"
	@read -p "ÃŠtes-vous sÃ»r? (y/n) " confirm && [ "$$confirm" = "y" ] && \
	python manage.py flush --noinput && \
	python manage.py migrate && \
	python manage.py init_roles && \
	python manage.py seed_users && \
	echo "$(GREEN)âœ“ Base de donnÃ©es rÃ©initialisÃ©e$(NC)" || echo "AnnulÃ©"

dumpdata:
	@echo "$(BLUE)Backup de la base de donnÃ©es...$(NC)"
	python manage.py dumpdata > backup_$(shell date +%Y%m%d_%H%M%S).json
	@echo "$(GREEN)âœ“ Backup crÃ©Ã©$(NC)"

loaddata:
	@echo "$(BLUE)Restauration de la base de donnÃ©es...$(NC)"
	@read -p "Fichier de backup (ex: backup_20240101_000000.json): " file && \
	python manage.py loaddata $$file && \
	echo "$(GREEN)âœ“ DonnÃ©es restaurÃ©es$(NC)"

# DÃ©veloppement
run:
	@echo "$(BLUE)DÃ©marrage du serveur de dÃ©veloppement...$(NC)"
	@echo "$(YELLOW)API:   http://localhost:8000/api/v1/$(NC)"
	@echo "$(YELLOW)Admin: http://localhost:8000/admin$(NC)"
	@echo "$(YELLOW)Docs:  http://localhost:8000/api/v1/docs/$(NC)"
	python manage.py runserver

shell:
	python manage.py shell

check:
	python manage.py check

# Tests
test:
	@echo "$(BLUE)ExÃ©cution des tests...$(NC)"
	pytest -v

test-users:
	@echo "$(BLUE)Tests du module users...$(NC)"
	pytest apps/users/tests.py -v

coverage:
	@echo "$(BLUE)Rapport de coverage...$(NC)"
	pytest --cov=apps --cov-report=html --cov-report=term-missing
	@echo "$(GREEN)âœ“ Rapport gÃ©nÃ©rÃ©: htmlcov/index.html$(NC)"

# Code Quality
lint:
	@echo "$(BLUE)ExÃ©cution des linters...$(NC)"
	black --check .
	flake8 .
	isort --check-only .
	@echo "$(GREEN)âœ“ Linters passÃ©s$(NC)"

format:
	@echo "$(BLUE)Formatage du code...$(NC)"
	black .
	isort .
	@echo "$(GREEN)âœ“ Code formatÃ©$(NC)"

mypy:
	@echo "$(BLUE)Type checking...$(NC)"
	mypy apps --ignore-missing-imports
	@echo "$(GREEN)âœ“ Type checking complÃ©tÃ©$(NC)"

# Docker
docker-build:
	@echo "$(BLUE)Building des images Docker...$(NC)"
	docker-compose build
	@echo "$(GREEN)âœ“ Images construites$(NC)"

docker-up:
	@echo "$(BLUE)DÃ©marrage des containers...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)âœ“ Containers dÃ©marrÃ©s$(NC)"
	@echo "$(YELLOW)API: http://localhost:8000/api/v1/$(NC)"

docker-down:
	@echo "$(BLUE)ArrÃªt des containers...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ“ Containers arrÃªtÃ©s$(NC)"

docker-logs:
	docker-compose logs -f backend

docker-shell:
	docker-compose exec backend bash

# Utilitaires
clean:
	@echo "$(BLUE)Nettoyage des fichiers temporaires...$(NC)"
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "build" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ“ Nettoyage terminÃ©$(NC)"

.DEFAULT_GOAL := help
